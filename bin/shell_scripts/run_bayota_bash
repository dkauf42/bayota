#!/bin/bash

MY_HOME=/home/dkaufman
PROJECT_HOME=${MY_HOME}/bayota

if [ $# -gt 0 ]; then
    STUDY=$1
else
    echo 'Usage: ./run_bayota_bash <study_name>'
    echo ''
    echo 'Enter name of the Study: '
    read STUDY
    INTERACTIVE=1
fi

STUDY_CONFIG_FILE=${PROJECT_HOME}/bin/studies/study_a1_mdcounties.cfg

echo ''
echo 'Locating SETTINGS Configuration File...'
if [ ! -f $STUDY_CONFIG_FILE ]; then
    echo 'Error'
    exit 1
fi

source ${STUDY_CONFIG_FILE}


# Define a timestamp function
timestamp() {
  date +"%Y%m%d-%H%M%S"
}
TIME_STAMP=timestamp
monthstamp() {
  date +"%Y%m"
}
MONTH_STAMP=monthstamp


# Directories to store Output and Logs
OUT_DIR=${OUTPUT_DIR_STEM}_${MONTH_STAMP}
mkdir -p $OUT_DIR

if [ -z ${PRIORITY} ]; then
    PRIORITY=5000
fi

echo 'Study: **' $STUDY '** in ' $PROJECT_HOME
echo 'Job Priority = ' $PRIORITY
echo ''
echo 'Continue? [Y/N]'
read response

if [ ${response} = 'Y' ] || [ ${response} = 'y' ]; then
    sbatch --nice=${PRIORITY} --job-name=${STUDY} ${PROJECT_HOME}/bin/study_cli.py -c ${STUDY_CONFIG_FILE}

    iRETURN=$?

    if [ ${iRETURN} -eq 1 ]; then
        echo 'SLURM Unable to Queue'
    else
        echo ''
        echo 'Running'
        echo ''
    fi
fi
